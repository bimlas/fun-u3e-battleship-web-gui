<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>u3e Battleship web GUI</title>
    <style>
        body {
            background-color: #a5a5ff;
            font-family: monospace;
            color: #ffff00;
            font-weight: bold;
        }
        .row, .column {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
        }
        .column {
            flex-direction: column;
        }
        .hud {
            background-color: #aaffee;
            color: #000000;
            width: 75%;
            min-height: 100px;
            border: 8px solid #a1683c;
            padding: 8px;
        }
        .battlefield {
            background-color: #4242e7;
            border: 8px solid #ffff00;
            width: 500px;
            height: 500px;
            line-height: 0;
        }
        .cell {
            display: inline-block;
            background-color: #4242e7;
            border: 1px solid #a5a5ff;
            box-sizing: border-box;
        }
        .active {
            background-color: #ffff00;
        }
    </style>
</head>
<script>
  document.addEventListener('DOMContentLoaded', event => {
    document.querySelector('#settings').addEventListener('submit', joinToGame);
    document.querySelector('#next-turn').addEventListener('click', updateGameState);
  });

  function joinToGame(event) {
    event.preventDefault();

    const playerName = document.querySelector('#player-name-input').value;
    postToServer('/snake', {playerName: playerName, action: 'joinGame'}, initGame);
  }

  function updateGameState(event) {
    event.preventDefault();
    getFromServer('/snake', initGame);
  }

  function getFromServer(path, callback) {
    const
      Http = new XMLHttpRequest(),
      url = document.querySelector('#server-address-input').value;

    Http.open("GET", `${url}${path}`);
    Http.send();

    Http.onreadystatechange = (e) => {
      if (Http.readyState === 4 && Http.status === 200) {
        callback(JSON.parse(Http.responseText));
      }
    }
  }

  function postToServer(path, data, callback) {
    const
      Http = new XMLHttpRequest(),
      url = document.querySelector('#server-address-input').value;

    Http.open("POST", `${url}${path}`);
    Http.send(JSON.stringify(data));

    Http.onreadystatechange = (e) => {
      if (Http.readyState === 4 && Http.status === 200) {
        callback(JSON.parse(Http.responseText));
      }
    }
  }

  function initGame(board) {
    const
      numberOfColumns = board[0].length,
      numberOfRows = board.length;

    document.querySelectorAll('.cell').forEach(cell => cell.remove());

    document.querySelectorAll('.battlefield').forEach(battlefield => {
      for (let y = 0; y < numberOfRows; y++) {
        for (let x = 0; x < numberOfColumns; x++) {
          const cell = createCell(numberOfColumns, numberOfRows);
          cell.classList.add(`x${x}`);
          cell.classList.add(`y${y}`);
          if(board[y][x] === 1) {
            cell.classList.add('active');
          }
          battlefield.appendChild(cell);
        }
      }
    });
  }

  function createCell(numberOfColumns, numberOfRows) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    cell.style.width = `${100 / numberOfColumns}%`;
    cell.style.height = `${100 / numberOfRows}%`;
    return cell;
  }
</script>
<body>
    <form id="settings" class="column">
        <h1>u3e Battleship</h1>
        <label>Player name<br/><input type="text" id="player-name-input"></label>
        <label>Server address<br/><input type="text" id="server-address-input"></label>
        <button type="submit">Connect</button>
        <button id="next-turn">Next turn</button>
    </form>
    <div class="row">
        <div class="column">
            <div class="battlefield" id="player"></div>
            <h2 id="player-name">Player</h2>
            <div class="hud">Remaining player ships...</div>
        </div>
        <div class="column">
            <div class="battlefield" id="enemy"></div>
            <h2 id="enemy-name">Enemy</h2>
            <div class="hud">Remaining enemy ships...</div>
        </div>
    </div>
</body>
</html>